import{a as k,V as Y,ah as v,j as e,bS as E,ao as T,aC as H,c1 as R,a7 as A,ad as I,z as O,s as z,v as B,aD as N,Q as K,aE as G,at as Q,a8 as $,au as V,ay as w,az as P,ap as M,bY as J}from"./index-CJshWYnI.js";import{u as X,A as U}from"./index-BQCm6EIb.js";import{u as D}from"./usePostMedia-BX-CzoG_.js";import{p as C}from"./promotionApi-An39Qkr8.js";import{C as W}from"./Chip-BTD110-q.js";import{A as L}from"./Avatar-vswzwpZe.js";import{S as Z}from"./index-Asi-kwjh.js";import{F as ee}from"./index-BWzBPWVm.js";import{L as se}from"./LinearProgress-CdSH6PMq.js";import{L as S}from"./LoadingButton-7NcAxfBL.js";import"./mediaApi-0L_v80OH.js";import"./discounts-ZsttU2u6.js";import"./index-C9ji92vU.js";const ae=({label:m="Gắn dịch vụ",required:i=!1,productable:t=[],onChangeProductable:h})=>{var b;const u=k.useRef(null),p=l=>{u.current&&(l==="hide"&&u.current.classList.remove("org-search-show"),l==="show"&&u.current.classList.add("org-search-show"))};window.addEventListener("click",()=>p("hide"));const{mutate:j,isLoading:x,data:f}=Y({mutationFn:l=>R.getAll(v.pickBy({keyword:l,on_ecommerce:!0,type:1},v.identity))}),_=k.useCallback(v.debounce(l=>j(l),600),[]),y=l=>_(l.target.value),s=l=>{h&&(t.findIndex(d=>d.id===l.id)<0?h([...t,l]):h(t.filter(d=>d.id!==l.id)))};return e.jsxs("div",{className:"col col-org",children:[e.jsxs("label",{className:`${i?"required":""} form-label`,children:[m," (",t.length," dịch vụ)"]}),e.jsx("div",{onClick:l=>{l.stopPropagation(),p("show")},className:"form-control form-control-solid",children:t.length>0?t.map(l=>e.jsx(W,{className:"m-1",color:"success",label:l.name,avatar:e.jsx(L,{alt:l.name,src:l.name}),onDelete:()=>s(l)},l.id)):"Gắn dịch vụ"}),e.jsx(E,{ref:u,sx:{boxShadow:3},className:"org-search",children:e.jsxs("div",{onClick:l=>l.stopPropagation(),children:[e.jsx("input",{onChange:y,type:"text",className:"form-control form-control-solid",placeholder:"Tìm kiếm dịch vụ..."}),x&&e.jsx(T,{size:16}),e.jsx("div",{className:"org-list",children:e.jsx("ul",{className:"list",children:(b=f==null?void 0:f.data)==null?void 0:b.map(l=>{var g,d;return e.jsxs(H,{selected:t.map(a=>a.id).includes(l.id),onClick:()=>s(l),children:[e.jsx(L,{style:{marginRight:"6px"},alt:l.name,src:l.organization[0]&&((g=l.organization[0])==null?void 0:g.image_url)}),e.jsxs("div",{className:"col",children:[e.jsx("p",{children:l.name}),e.jsx("p",{className:"org-name",children:(d=l.organization[0])==null?void 0:d.name})]})]},l.id)})})})]})})]})};function le(m){if(m)return m.replace(/<p\s+data-f-id="pbf"[^>]*>Powered by\s*<a[^>]*>Froala Editor<\/a><\/p>/g," ")}function ve(){const m=A(),i=I(),{handlePostMedia:t,isLoading:h}=D(),{handlePostMedia:u,isLoading:p}=D(),{resultLoad:j,noti:x,onCloseNoti:f}=X(),{mutateAsync:_,isLoading:y}=Y({mutationFn:a=>i.id?C.put(i.id,a):C.post(a),onSuccess:()=>{j({message:i.id?"Cập nhật promotion thành công":"Tạo mới promotion thành công",color:"success"}),setTimeout(()=>m(-1),1500)},onError:a=>{var o;const n=a;j({color:"error",message:`Có lỗi xảy ra. Mã lỗi ${(o=n==null?void 0:n.request)==null?void 0:o.status}`})}}),s=O({initialValues:{name:"",content:"",media_url:"",main_media_id:void 0,thumbnail_url:"",thumbnail_media_id:void 0,is_popup:!1,valid_from:N().format("YYYY-MM-DD HH:mm:ss"),valid_util:N().format("YYYY-MM-DD HH:mm:ss"),discounts:[],productables:[],priority:0,url:"",token:"",color:"",platform:""},validationSchema:z({name:B().required("Nhập tên của promotion")}),onSubmit:async a=>{const{url:n,token:o,platform:r,color:c}=a,q=v.pickBy({...a,productables:a.productables.map(F=>F.id),discounts:a.discounts.map(F=>F.id),content:a.priority<0?JSON.stringify({url:n,token:o,platform:r,color:c}):le(a.content)},v.identity);await _({...q,is_popup:a.is_popup?1:0})&&(s.setFieldValue("main_media_id",void 0),s.setFieldValue("thumbnail_media_id",void 0))}}),{refetch:b,isFetching:l}=K({queryKey:[G.PROMOTION,i.id],queryFn:()=>C.getDetail(i.id),enabled:!!i.id,onSuccess:a=>{s.setFieldValue("is_popup",a.context.is_popup===1),s.setFieldValue("name",a.context.name),s.setFieldValue("content",a.context.content),s.setFieldValue("media_url",a.context.media_url),s.setFieldValue("thumbnail_url",a.context.thumbnail_url),s.setFieldValue("valid_from",a.context.valid_from),s.setFieldValue("valid_util",a.context.valid_util),s.setFieldValue("productables",a.context.productables),s.setFieldValue("discounts",a.context.discounts),s.setFieldValue("priority",a.context.priority);try{const{url:n,token:o,platform:r,color:c}=JSON.parse(a.context.content);s.setFieldValue("url",n),s.setFieldValue("token",o),s.setFieldValue("platform",r),s.setFieldValue("color",c)}catch{}}}),g=a=>{s.setFieldValue("media_url",""),t({e:{target:{files:[a]}},callBack(o){var r,c;s.setFieldValue("media_url",((r=o[0])==null?void 0:r.original_url)??""),s.setFieldValue("main_media_id",(c=o[0])==null?void 0:c.model_id)},version:"myspa"})},d=a=>{s.setFieldValue("",""),u({e:{target:{files:[a]}},callBack(o){var r,c;s.setFieldValue("thumbnail_url",((r=o[0])==null?void 0:r.original_url)??""),s.setFieldValue("thumbnail_media_id",(c=o[0])==null?void 0:c.model_id)},version:"myspa"})};return e.jsxs(Q,{permissions:i.id?["v1.promotions.update"]:["v1.promotions.store"],showEmpty:!0,children:[e.jsx(U,{severity:x.color,message:x.message,open:x.openAlert,close:f}),e.jsx($,{title:i.id?"Cập nhật promotion":"Tạo mới promotion"}),e.jsx("div",{className:"post d-flex flex-column-fluid",id:"kt_post",children:e.jsx("div",{className:"promotion-form",children:e.jsxs("form",{autoComplete:"off",onSubmit:s.handleSubmit,className:"form",children:[e.jsxs("div",{className:"flex-row align-items-center input-wrap",children:[e.jsx("div",{className:"wrap-item",children:e.jsx(V,{value:s.values.is_popup,onChange:a=>s.setFieldValue("is_popup",a.target.checked),label:"Is Popup"})}),e.jsx("div",{className:"wrap-item",children:e.jsx(V,{value:s.values.priority<0,onChange:a=>s.setFieldValue("priority",a.target.checked?-1:0),label:"Webview đối tác"})})]}),s.values.priority<0&&e.jsxs("div",{style:{border:"solid 1px var(--kt-gray-500)",padding:6,borderRadius:6,margin:"6px 0px"},children:[e.jsx("div",{className:"required form-label",children:"Cài đặt webview"}),e.jsxs("div",{className:"d-flex justify-content-between",children:[e.jsxs("div",{className:"w-50",style:{paddingRight:6},children:[e.jsx("div",{className:"required form-label",children:"Link webview"}),e.jsx("input",{type:"text",value:s.values.url,onChange:s.handleChange,name:"url",className:"form-control form-control-solid mt-4 mb-2",placeholder:"URL..."})]}),e.jsxs("div",{className:"w-50",style:{paddingLeft:12},children:[e.jsx("div",{className:"required form-label",children:"Token"}),e.jsx("input",{type:"text",value:s.values.token,onChange:s.handleChange,name:"token",className:"form-control form-control-solid mt-4 mb-2",placeholder:"Token"})]})]}),e.jsxs("div",{className:"d-flex justify-content-between",children:[e.jsxs("div",{className:"w-50",style:{paddingRight:6},children:[e.jsx("div",{className:"required form-label",children:"Platform"}),e.jsx("input",{type:"text",value:s.values.platform,onChange:s.handleChange,name:"platform",className:"form-control form-control-solid mt-4 mb-2",placeholder:"Platform..."})]}),e.jsxs("div",{className:"w-50",style:{paddingLeft:12},children:[e.jsx("div",{className:"required form-label",children:"Color"}),e.jsx("input",{type:"text",value:s.values.color,onChange:s.handleChange,name:"color",className:"form-control form-control-solid mt-4 mb-2",placeholder:"color"})]})]})]}),e.jsxs("div",{className:"column",children:[e.jsx("div",{className:"required form-label",children:"Hình ảnh"}),e.jsx("div",{className:"drag-banner",children:e.jsx(w,{over:!0,className:"form-input-file",style:{width:"100%"},multiple:!1,handleChange:g,name:"file",types:P,children:e.jsxs("div",{className:"banner-form__img",children:[e.jsx("img",{src:s.values.media_url!==""?s.values.media_url:M.imgPlaceHolder,alt:"",className:"image-value"}),h&&e.jsxs("div",{className:"placeholder",children:[e.jsx("span",{children:"Đang tải"}),e.jsx(T,{})]}),s.values.media_url===""&&e.jsx("div",{className:"placeholder",children:e.jsx("span",{children:"Kéo thả hình ảnh vào đây hoặc Click để chọn hình ảnh"})})]})})}),e.jsx("input",{type:"text",name:"image_url",className:"form-control form-control-solid mt-4 mb-2",placeholder:"Hoặc link hình ảnh...."}),s.errors.media_url&&s.touched.media_url&&e.jsx("span",{className:"text-danger",children:s.errors.media_url})]}),e.jsx("div",{className:"required form-label",children:"Thumbnail"}),e.jsx("div",{className:"drag-banner",children:e.jsx(w,{className:"form-input-file",style:{width:"100%"},multiple:!1,handleChange:d,name:"thumbnail",types:P,children:e.jsxs("div",{className:"banner-form__img",children:[e.jsx("img",{src:s.values.thumbnail_url!==""?s.values.thumbnail_url:M.imgPlaceHolder,alt:"",className:"image-value"}),s.values.thumbnail_url===""&&e.jsxs("div",{className:"placeholder",children:[e.jsx("span",{children:p?"Đang tải":"Kéo thả hình ảnh vào đây hoặc Click để chọn hình ảnh"}),p&&e.jsx(se,{})]})]})})}),e.jsx("input",{value:s.values.thumbnail_url,onChange:s.handleChange,type:"text",name:"thumbnail_url",className:"form-control form-control-solid mt-4 mb-2",placeholder:"Hoặc link hình ảnh...."}),e.jsxs("div",{className:"column",children:[e.jsx("div",{className:"required form-label",children:"Tên promotion"}),e.jsx("input",{value:s.values.name,onChange:s.handleChange,type:"text",name:"name",className:"form-control form-control-solid mt-4 mb-2",placeholder:"Tên promotion...."}),s.errors.name&&s.touched.name&&e.jsx("span",{className:"text-danger",children:s.errors.name})]}),e.jsxs("div",{className:"column",children:[e.jsx("div",{className:"form-label",children:"Mô tả"}),e.jsx(ee,{model:s.values.content,onModelChange:a=>s.setFieldValue("content",a),tag:"textarea"})]}),e.jsx("div",{className:"column",children:e.jsx(J,{required:!0,startDate:new Date(s.values.valid_from),endDate:new Date(s.values.valid_util),onChange:a=>{s.setFieldValue("valid_from",N(a.selection.startDate).format("YYYY-MM-DD HH:mm:ss")),s.setFieldValue("valid_util",N(a.selection.endDate).format("YYYY-MM-DD HH:mm:ss"))}})}),e.jsx("div",{className:"column mt-6",children:e.jsx(ae,{productable:s.values.productables,onChangeProductable:a=>s.setFieldValue("productables",a)})}),e.jsx("div",{className:"column mt-6",children:e.jsx(Z,{filterAll:!1,discounts:s.values.discounts,onChangeDiscounts:a=>s.setFieldValue("discounts",a)})}),e.jsxs("div",{className:"d-flex justify-content-end mt-8",children:[i.id&&e.jsx(S,{style:{marginRight:"8px"},loading:l,type:"submit",size:"large",color:"inherit",variant:"contained",onClick:()=>b(),children:"Khôi phục"}),e.jsx(S,{loading:y,type:"submit",size:"large",color:"success",variant:"contained",children:i.id?"Cập nhật Promo":"Tạo mới Promo"})]})]})})})]})}export{ve as default};
