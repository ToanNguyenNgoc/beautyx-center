import{aF as B,a as E,V as z,bR as Q,ah as W,j as e,bS as P,ao as K,aC as b,aD as j,a7 as J,z as Z,s as ee,bT as v,bU as d,aH as D,bV as ae,v as h,bW as q,bM as g,au as le,aA as se,aB as I,bH as te,bN as N,bQ as ie,bX as re,bO as ne,bY as oe,ad as ce,Q as me,aE as de,at as ue,a8 as pe,am as he}from"./index-CwORS_Xz.js";/* empty css              */import{u as ge,A as xe}from"./index-D_k0cNNM.js";import{d as M}from"./discounts-hb3ODqxG.js";import{u as ve}from"./useGetGmupTags-2BofUJ1p.js";import{F as fe}from"./index-CFe7ZqH4.js";import{C as _e}from"./Chip-C1Mk8h_P.js";import{A as je}from"./Avatar-DJSVcfmv.js";import{S as Ne}from"./select-service-Cda5lygL.js";import{E as be}from"./export-code-fzAuZcS5.js";import{L as Ce}from"./LoadingButton-Yjdjcb8X.js";import"./axios.instance-4ExcG6zI.js";const Te=({label:n="Gắn doanh nghiệp",origins:c=[],onChangeOrigin:r})=>{var T;const{isBeautyxSite:x}=B(),m=E.useRef(null),a=t=>{m.current&&(t==="hide"&&m.current.classList.remove("org-search-show"),t==="show"&&m.current.classList.add("org-search-show"))};window.addEventListener("click",()=>a("hide"));const{data:i,mutate:C,isLoading:w}=z({mutationFn:t=>Q.getAll(x?{keyword:t,is_ecommerce:!0}:{keyword:t,is_gmup:!0}).then(p=>p.data.context)}),f=E.useCallback(W.debounce(t=>C(t),600),[]),y=t=>f(t.target.value),u=t=>{r&&(c.findIndex(_=>_.id===t.id)<0?r([...c,t]):r(c.filter(_=>_.id!==t.id)))};return e.jsxs("div",{className:"col col-org",children:[e.jsx("label",{className:"required filter-row_label mb-2",children:n}),e.jsx("div",{onClick:t=>{t.stopPropagation(),a("show")},className:"form-control form-control-solid",children:c.length>0?c.map(t=>e.jsx(_e,{className:"m-1",color:"primary",label:t.name,avatar:e.jsx(je,{alt:t.subdomain,src:t.image_url}),onDelete:()=>u(t)},t.id)):"Gắn doanh nghiệp"}),e.jsx(P,{ref:m,sx:{boxShadow:3},className:"org-search",children:e.jsxs("div",{onClick:t=>t.stopPropagation(),children:[e.jsx("input",{onChange:y,type:"text",className:"form-control form-control-solid",placeholder:"Tìm kiếm..."}),w&&e.jsx(K,{size:16}),e.jsx("div",{className:"org-list",children:e.jsx("ul",{className:"list",children:(T=i==null?void 0:i.data)==null?void 0:T.map(t=>e.jsx(b,{selected:c.map(p=>p.id).includes(t.id),onClick:()=>u(t),children:t.name},t.id))})})]})})]})};function De(n){var A,Y,R,O;const{rootSite:c,isBeautyxSite:r}=B(),{gmupTags:x}=ve({limit:100,"filter[is_root]":!1,"filter[status]":!0}),m=j().format("MMDDss"),{discount:a,isForm:i}=n,{resultLoad:C,onCloseNoti:w,noti:f}=ge(),y=J(),[u,T]=E.useState((a==null?void 0:a.is_campaign)??!1),[t,p]=E.useState(i==="EDIT"?a==null?void 0:a.items.map(s=>s.productable):[]),{mutate:_,isLoading:G}=z({mutationFn:s=>a?M.putDiscount(a.id,s):M.postDiscount(s),onSuccess:()=>{C({message:a?"Cập nhật thành công":"Tạo thành công",color:"success"}),setTimeout(()=>y(-1),2e3)},onError:(s,o,L)=>{C({message:"Có lỗi xảy ra",color:"error"})}}),l=Z({initialValues:{priority:i==="EDIT"?a==null?void 0:a.priority:0,coupon_code:r?i==="EDIT"?a==null?void 0:a.coupon_code:"":`GMUP-${new Date().getTime()}`,title:i==="EDIT"?a==null?void 0:a.title:"",description:i==="EDIT"?a==null?void 0:a.description:"",platform:r?i==="EDIT"&&(a!=null&&a.platform)?(Y=(A=a==null?void 0:a.platform)==null?void 0:A.split("|"))==null?void 0:Y.filter(Boolean):[]:[D.GMUP],discount_type:r?i==="EDIT"?a==null?void 0:a.discount_type:"":d.FINAL_PRICE,discount_unit:r?i==="EDIT"?a==null?void 0:a.discount_unit:"":v.PRICE,discount_value:i==="EDIT"?a==null?void 0:a.discount_value:"",organizations:i==="EDIT"?a==null?void 0:a.organizations:[],total:r?i==="EDIT"&&(a!=null&&a.total)?a==null?void 0:a.total:"":3e3,valid_from:i==="EDIT"&&(a!=null&&a.valid_from)?a==null?void 0:a.valid_from:j().format("YYYY-MM-DD HH:mm:ss"),valid_util:i==="EDIT"&&(a!=null&&a.valid_util)?a==null?void 0:a.valid_util:j().format("YYYY-MM-DD HH:mm:ss"),minimum_order_value:r?i==="EDIT"&&(a!=null&&a.maximum_discount_value)?a==null?void 0:a.maximum_discount_value:"":0,limit:r?i==="EDIT"&&(a!=null&&a.limit)?a==null?void 0:a.limit:"":void 0,gmup_tag_ids:i==="EDIT"?(R=a==null?void 0:a.gmup_tags)==null?void 0:R.map(s=>Number(s.id)).filter(Boolean):[]},validationSchema:ee({coupon_code:h().required("Vui lòng nhập Mã giảm giá"),title:h().required("Vui lòng nhập tên"),description:h().required("Vui lòng nhập mô tả"),discount_type:h().required("Vui lòng chọn hình thức giảm giá"),discount_unit:h().required("Vui lòng chọn loại giảm giá "),discount_value:h().required("Vui lòng nhập giá trị giảm"),platform:q().min(1,"Vui lòng chọn nền tảng áp dụng"),organizations:q().min(1,"Vui lòng chọn Doanh nghiệp"),total:u?ae().min(0,"Số lượng mã tối đa 4000 mã").max(4e3,"Số lượng mã tối đa 4000 mã").required("Vui lòng nhập số lượng mã"):h()}),onSubmit:s=>{var U;const o=s,L={...o,organizations:(U=s.organizations)==null?void 0:U.map(F=>F.id)[0],items:t.map(F=>F.id),platform:r?o.platform[0]??"MOMO":D.GMUP,is_campaign:u?1:0,limit:Number(s.limit)};t.length>0&&_(L)}}),S=Math.min.apply(null,t.map(s=>s==null?void 0:s.price));let V=0;t.length>0&&(V=(O=t==null?void 0:t.map(s=>s==null?void 0:s.price))==null?void 0:O.reduce((s,o)=>s+o));const k=s=>{l.values.discount_unit===v.PERCENT?(parseInt(s.target.value)<100||s.target.value==="")&&l.setFieldValue("discount_value",s.target.value):l.values.discount_unit===v.PRICE&&(l.values.discount_type===d.PRODUCTS&&(parseInt(s.target.value)<=S||s.target.value==="")&&l.setFieldValue("discount_value",s.target.value),l.values.discount_type===d.SUB_TOTAL&&(parseInt(s.target.value)<V||s.target.value==="")&&l.setFieldValue("discount_value",s.target.value),l.values.discount_type===d.FINAL_PRICE&&(parseInt(s.target.value)<=S||s.target.value==="")&&l.setFieldValue("discount_value",s.target.value))},H=s=>{(s.target.value>0||s.target.value==="")&&(l.setFieldValue("total",s.target.value),l.setFieldValue("limit",""))},X=s=>{l.values.discount_type===d.SUB_TOTAL&&l.values.discount_value===""&&l.setFieldValue("minimum_order_value",s.target.value)},$=s=>{const o=parseInt(`${l.values.total}`);if(l.values.total===""||typeof o=="number"&&parseInt(s.target.value)<o||s.target.value==="")return l.setFieldValue("limit",s.target.value)};return e.jsxs(e.Fragment,{children:[e.jsx(xe,{severity:f.color,message:f.message,open:f.openAlert,close:w}),e.jsxs("form",{className:"discount-form",onSubmit:l.handleSubmit,autoComplete:"off",children:[c==g.BEAUTYX&&e.jsx("div",{className:"flex-row-sp align-items-center input-wrap",children:e.jsx("div",{className:"wrap-item",children:e.jsx(le,{value:u,onChange:s=>T(s.target.checked),label:"Is campaign (Áp dụng mã giảm giá Shopee, VinId, Viettel Money, Livwell)"})})}),e.jsxs("div",{className:"flex-row-sp input-wrap",children:[e.jsxs("div",{className:"wrap-item",children:[e.jsx("label",{className:"form-label",children:"Độ ưu tiên"}),e.jsx("input",{onChange:l.handleChange,value:l.values.priority,name:"priority",type:"number",className:"form-control form-control-solid",placeholder:"Độ ưu tiên"})]}),e.jsxs("div",{className:"wrap-item d-flex flex-column",children:[e.jsx("label",{className:"form-label",children:"Tag dịch vụ"}),e.jsx(se,{sx:{m:1,minWidth:120},size:"small",children:e.jsx(I,{value:l.values.gmup_tag_ids.length>0?l.values.gmup_tag_ids[0]:void 0,onChange:s=>l.setFieldValue("gmup_tag_ids",[s.target.value]),renderValue:()=>e.jsx(P,{sx:{display:"flex",flexWrap:"wrap",gap:.5},children:x.filter(s=>{var o;return(o=l.values.gmup_tag_ids)==null?void 0:o.includes(s.id||0)}).map(s=>e.jsx("span",{children:s.name},s.id))}),children:x.map(s=>e.jsx(b,{value:s.id,children:s.name},s.id))})})]})]}),e.jsxs("div",{className:"flex-row-sp input-wrap",children:[e.jsxs("div",{className:"wrap-item",children:[i==="ADD"?e.jsx("label",{className:"required form-label",children:r?`Mã giảm giá (org subdomain + ${m})`:"Code"}):e.jsx("label",{className:"required form-label",children:"Mã giảm giá"}),e.jsx("input",{onChange:l.handleChange,value:l.values.coupon_code,name:"coupon_code",type:"text",className:"form-control form-control-solid",placeholder:`Example:ORG${m}`}),l.errors.coupon_code&&l.touched.coupon_code&&e.jsx("span",{className:"text-danger",children:l.errors.coupon_code})]}),e.jsxs("div",{className:"wrap-item",children:[e.jsx("label",{className:"required form-label",children:"Tên"}),e.jsx("input",{onChange:l.handleChange,value:l.values.title,name:"title",type:"text",className:"form-control form-control-solid",placeholder:"Tên"}),l.errors.title&&l.touched.title&&e.jsx("span",{className:"text-danger",children:l.errors.title})]})]}),e.jsxs("div",{className:"input-wrap",children:[e.jsx("label",{className:"required form-label",children:"Mô tả"}),e.jsx("input",{onChange:l.handleChange,value:l.values.description,name:"description",type:"text",className:"form-control form-control-solid",placeholder:"Mô tả "}),l.errors.description&&l.touched.description&&e.jsx("span",{className:"text-danger",children:l.errors.description})]}),c===g.BEAUTYX&&e.jsxs("div",{className:"flex-col input-wrap",children:[e.jsx("label",{className:"required form-label",children:"Áp dụng cho nền tảng"}),e.jsx(I,{labelId:"demo-multiple-chip-label",id:"demo-multiple-chip",multiple:!0,value:l.values.platform,onChange:l.handleChange,name:"platform",renderValue:s=>e.jsx(P,{sx:{display:"flex",flexWrap:"wrap",gap:.5},children:s==null?void 0:s.map(o=>e.jsx(fe,{platForm:o},o))}),children:te.map(s=>e.jsx(b,{value:s,children:s},s))}),l.errors.platform&&l.touched.platform&&e.jsx("span",{className:"text-danger",children:l.errors.platform})]}),e.jsxs("div",{className:"flex-col input-wrap",children:[e.jsx(Te,{label:"Doanh nghiệp được áp dụng",origins:l.values.organizations,onChangeOrigin:s=>{p([]),l.setFieldValue("organizations",s)}}),l.errors.organizations&&l.touched.organizations&&e.jsx("span",{className:"text-danger",children:l.errors.organizations})]}),e.jsx("div",{className:"flex-col input-wrap",children:e.jsx(Ne,{values:t,setValues:p,orgsChoose:l.values.organizations})}),e.jsxs("div",{className:"flex-row-sp input-wrap",children:[e.jsx(N,{site:g.BEAUTYX,children:e.jsxs("div",{className:"flex-col wrap-item wrap-item-col-4",children:[e.jsx("label",{className:"required form-label",children:"Hình thức giảm giá "}),e.jsx(I,{labelId:"demo-simple-select-label",id:"demo-simple-select",value:l.values.discount_type,onChange:l.handleChange,name:"discount_type",children:ie.map(s=>e.jsx(b,{value:s.TYPE,children:s.title},s.id))}),l.errors.discount_type&&l.touched.discount_type&&e.jsx("span",{className:"text-danger",children:l.errors.discount_type})]})}),e.jsx(N,{site:g.BEAUTYX,children:e.jsxs("div",{className:"flex-col wrap-item wrap-item-col-4",children:[e.jsx("label",{className:"required form-label",children:"Giảm giá theo"}),e.jsx(I,{labelId:"demo-simple-select-label",id:"demo-simple-select",value:l.values.discount_unit,onChange:s=>{l.setFieldValue("discount_value",""),l.setFieldValue("discount_unit",s.target.value)},name:"discount_unit",children:re.map(s=>e.jsx(b,{value:s.TYPE,children:s.title},s.id))}),l.errors.discount_unit&&l.touched.discount_unit&&e.jsx("span",{className:"text-danger",children:l.errors.discount_unit})]})}),e.jsxs("div",{className:"wrap-item wrap-item-col-4",children:[e.jsxs("label",{className:"required form-label",children:[l.values.discount_type===d.FINAL_PRICE?"Giảm giá còn":"Giá trị giảm giá",l.values.discount_unit===v.PERCENT&&"(%)",l.values.discount_unit===v.PRICE&&"(VNĐ)"]}),e.jsx("input",{onChange:k,value:l.values.discount_value,name:"discount_value",type:"text",className:"form-control form-control-solid",placeholder:l.values.discount_unit===v.PRICE?`Giá trị giảm tối đa ${ne(l.values.discount_type===d.SUB_TOTAL?V:S)}đ`:"Giảm giá"}),l.errors.discount_value&&l.touched.discount_value&&e.jsx("span",{className:"text-danger",children:l.errors.discount_value})]})]}),e.jsx("div",{className:"flex-row-sp input-wrap",children:e.jsx(N,{site:g.BEAUTYX,children:e.jsxs("div",{className:"wrap-item wrap-item-col-4",children:[e.jsx("label",{className:"form-label",children:"Giá trị đơn hàng tối thiểu"}),e.jsx("input",{onChange:X,value:l.values.minimum_order_value,name:"minimum_order_value",disabled:l.values.discount_type===d.PRODUCTS,type:"text",className:"form-control form-control-solid",placeholder:"Giá áp dụng"})]})})}),e.jsxs("div",{className:"flex-row-sp input-wrap",children:[e.jsx(N,{site:g.BEAUTYX,children:e.jsxs("div",{className:"wrap-item wrap-item-col-4",children:[e.jsx("label",{className:`${u?"required":""} form-label`,children:"Số lượng"}),e.jsx("input",{value:l.values.total,onChange:H,name:"total",type:"text",className:"form-control form-control-solid",placeholder:""}),l.errors.total&&l.touched.total&&e.jsx("span",{className:"text-danger",children:l.errors.total})]})}),e.jsx(N,{site:g.BEAUTYX,children:e.jsxs("div",{className:"wrap-item wrap-item-col-4",children:[e.jsx("label",{className:"form-label",children:"Lượt sử dụng mỗi khách hàng "}),e.jsx("input",{value:l.values.limit,onChange:$,name:"limit",type:"number",className:"form-control form-control-solid",placeholder:""})]})}),e.jsx("div",{className:"wrap-item wrap-item-col-4",children:e.jsx(oe,{minDate:new Date,startDate:new Date(l.values.valid_from),endDate:new Date(l.values.valid_util),onChange:s=>{l.setFieldValue("valid_from",j(s.selection.startDate).format("YYYY-MM-DD HH:mm:ss")),l.setFieldValue("valid_util",j(s.selection.endDate).format("YYYY-MM-DD HH:mm:ss"))}})})]}),e.jsxs("div",{className:"input-form__bot",children:[e.jsx(Ce,{loading:G,type:"submit",variant:"contained",size:"large",color:"success",children:"Lưu thay đổi"}),a&&(a.platform===D.SHOPEE||a.platform===D.VINID)&&e.jsx(be,{discount:a})]})]})]})}function Oe(){const n=ce();let c="ADD";n&&n.id&&(c="EDIT");const{data:r,refetch:x,isLoading:m}=me({queryKey:[[de.DISCOUNT,n.id]],queryFn:()=>M.getDiscountDetail({id:n.id,include:"gmup_tags"}),enabled:!!n.id}),a=r==null?void 0:r.context;return e.jsxs(ue,{permissions:n!=null&&n.id?["v1.discounts.update"]:["v1.discounts.store"],showEmpty:!0,children:[e.jsx(pe,{title:n!=null&&n.id?"Chỉnh thông tin giảm giá":"Tạo mới mã giảm giá"}),e.jsx("div",{className:"post d-flex flex-column-fluid",id:"kt_post",children:e.jsxs("div",{className:"container",children:[m&&e.jsx(he,{}),(c==="ADD"||a)&&e.jsx(De,{isForm:c,discount:a,onRestoreFormEdit:x})]})})]})}export{be as ExportCode,Oe as default};
