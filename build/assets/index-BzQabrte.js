import{a as N,W as L,bH as z,ah as U,j as e,bI as R,ao as H,bz as j,b4 as f,a7 as G,B,v as $,bJ as K,w as d,bK as M,bL as Q,by as y,bF as W,bM as X,bN as p,bO as _,bE as J,bP as Z,e as ee,ad as ae,S as le,b6 as se,b1 as te,a8 as ie,am as re}from"./index-BHl1vF-Z.js";/* empty css              */import{P as ne,a as O}from"./platForm-CEzyLLuJ.js";import{F as oe}from"./index-BS_oHEVL.js";import{u as ce,A as me}from"./index-CqMaASZ6.js";import{d as T}from"./discounts-CUePuapv.js";import{C as ue}from"./Chip-DrXhVjId.js";import{A as de}from"./Avatar-Ckuqs-6L.js";import{S as pe}from"./select-service-BR9ayGpm.js";import{E as he}from"./export-code-CJM8pBnj.js";import{L as ge}from"./LoadingButton-BU6aPnkN.js";const ve=({label:v="Gắn doanh nghiệp",origins:r=[],onChangeOrigin:l})=>{var x;const i=N.useRef(null),m=t=>{i.current&&(t==="hide"&&i.current.classList.remove("org-search-show"),t==="show"&&i.current.classList.add("org-search-show"))};window.addEventListener("click",()=>m("hide"));const{data:u,mutate:c,isLoading:b}=L({mutationFn:t=>z.getAll({keyword:t,is_ecommerce:!0}).then(g=>g.data.context)}),h=N.useCallback(U.debounce(t=>c(t),600),[]),D=t=>h(t.target.value),n=t=>{l&&(r.findIndex(a=>a.id===t.id)<0?l([...r,t]):l(r.filter(a=>a.id!==t.id)))};return e.jsxs("div",{className:"col col-org",children:[e.jsx("label",{className:"required filter-row_label mb-2",children:v}),e.jsx("div",{onClick:t=>{t.stopPropagation(),m("show")},className:"form-control form-control-solid",children:r.length>0?r.map(t=>e.jsx(ue,{className:"m-1",color:"primary",label:t.name,avatar:e.jsx(de,{alt:t.subdomain,src:t.image_url}),onDelete:()=>n(t)},t.id)):"Gắn doanh nghiệp"}),e.jsx(R,{ref:i,sx:{boxShadow:3},className:"org-search",children:e.jsxs("div",{onClick:t=>t.stopPropagation(),children:[e.jsx("input",{onChange:D,type:"text",className:"form-control form-control-solid",placeholder:"Tìm kiếm..."}),b&&e.jsx(H,{size:16}),e.jsx("div",{className:"org-list",children:e.jsx("ul",{className:"list",children:(x=u==null?void 0:u.data)==null?void 0:x.map(t=>e.jsx(j,{selected:r.map(g=>g.id).includes(t.id),onClick:()=>n(t),children:t.name},t.id))})})]})})]})};function xe(v){var E,S,F;const r=f().format("MMDDss"),{discount:l,isForm:i}=v,{resultLoad:m,onCloseNoti:u,noti:c}=ce(),b=G(),[h,D]=N.useState((l==null?void 0:l.is_campaign)??!1),[n,x]=N.useState(i==="EDIT"?l==null?void 0:l.items.map(s=>s.productable):[]),{mutate:t,isLoading:g}=L({mutationFn:s=>l?T.putDiscount(l.id,s):T.postDiscount(s),onSuccess:()=>{m({message:l?"Cập nhật thành công":"Tạo thành công",color:"success"}),setTimeout(()=>b(-1),2e3)},onError:(s,o,V)=>{m({message:"Có lỗi xảy ra",color:"error"})}}),a=B({initialValues:{priority:i==="EDIT"?l==null?void 0:l.priority:0,coupon_code:i==="EDIT"?l==null?void 0:l.coupon_code:"",title:i==="EDIT"?l==null?void 0:l.title:"",description:i==="EDIT"?l==null?void 0:l.description:"",platform:i==="EDIT"&&(l!=null&&l.platform)?(S=(E=l==null?void 0:l.platform)==null?void 0:E.split("|"))==null?void 0:S.filter(Boolean):[],discount_type:i==="EDIT"?l==null?void 0:l.discount_type:"",discount_unit:i==="EDIT"?l==null?void 0:l.discount_unit:"",discount_value:i==="EDIT"?l==null?void 0:l.discount_value:"",organizations:i==="EDIT"?l==null?void 0:l.organizations:[],total:i==="EDIT"&&(l!=null&&l.total)?l==null?void 0:l.total:"",valid_from:i==="EDIT"&&(l!=null&&l.valid_from)?l==null?void 0:l.valid_from:f().format("YYYY-MM-DD HH:mm:ss"),valid_util:i==="EDIT"&&(l!=null&&l.valid_util)?l==null?void 0:l.valid_util:f().format("YYYY-MM-DD HH:mm:ss"),minimum_order_value:i==="EDIT"&&(l!=null&&l.maximum_discount_value)?l==null?void 0:l.maximum_discount_value:"",limit:i==="EDIT"&&(l!=null&&l.limit)?l==null?void 0:l.limit:""},validationSchema:$({coupon_code:d().required("Vui lòng nhập Mã giảm giá"),title:d().required("Vui lòng nhập tên chương trình khuyến mại"),description:d().required("Vui lòng nhập mô tả chương trình khuyến mại"),discount_type:d().required("Vui lòng chọn hình thức giảm giá"),discount_unit:d().required("Vui lòng chọn loại giảm giá "),discount_value:d().required("Vui lòng nhập giá trị giảm"),platform:M().min(1,"Vui lòng chọn nền tảng áp dụng"),organizations:M().min(1,"Vui lòng chọn Doanh nghiệp"),total:h?K().min(0,"Số lượng mã tối đa 4000 mã").max(4e3,"Số lượng mã tối đa 4000 mã").required("Vui lòng nhập số lượng mã"):d()}),onSubmit:s=>{var P;const o=s,V={...o,organizations:(P=s.organizations)==null?void 0:P.map(w=>w.id)[0],items:n.map(w=>w.id),platform:o.platform[0]??"MOMO",is_campaign:h?1:0,limit:Number(s.limit)};n.length>0&&t(V)}}),C=Math.min.apply(null,n.map(s=>s==null?void 0:s.price));let I=0;n.length>0&&(I=(F=n==null?void 0:n.map(s=>s==null?void 0:s.price))==null?void 0:F.reduce((s,o)=>s+o));const Y=s=>{a.values.discount_unit===_.PERCENT?(parseInt(s.target.value)<100||s.target.value==="")&&a.setFieldValue("discount_value",s.target.value):a.values.discount_unit===_.PRICE&&(a.values.discount_type===p.PRODUCTS&&(parseInt(s.target.value)<C||s.target.value==="")&&a.setFieldValue("discount_value",s.target.value),a.values.discount_type===p.SUB_TOTAL&&(parseInt(s.target.value)<I||s.target.value==="")&&a.setFieldValue("discount_value",s.target.value),a.values.discount_type===p.FINAL_PRICE&&(parseInt(s.target.value)<C||s.target.value==="")&&a.setFieldValue("discount_value",s.target.value))},A=s=>{(s.target.value>0||s.target.value==="")&&(a.setFieldValue("total",s.target.value),a.setFieldValue("limit",""))},q=s=>{a.values.discount_type===p.SUB_TOTAL&&a.values.discount_value===""&&a.setFieldValue("minimum_order_value",s.target.value)},k=s=>{const o=parseInt(`${a.values.total}`);if(a.values.total===""||typeof o=="number"&&parseInt(s.target.value)<o||s.target.value==="")return a.setFieldValue("limit",s.target.value)};return e.jsxs(e.Fragment,{children:[e.jsx(me,{severity:c.color,message:c.message,open:c.openAlert,close:u}),e.jsxs("form",{className:"discount-form",onSubmit:a.handleSubmit,autoComplete:"off",children:[e.jsx("div",{className:"flex-row-sp align-items-center input-wrap",children:e.jsx("div",{className:"wrap-item",children:e.jsx(Q,{value:h,onChange:s=>D(s.target.checked),label:"Is campaign (Áp dụng mã giảm giá Shopee, VinId, Viettel Money, Livwell)"})})}),e.jsx("div",{className:"flex-row-sp input-wrap",children:e.jsxs("div",{className:"wrap-item",children:[e.jsx("label",{className:"form-label",children:"Độ ưu tiên"}),e.jsx("input",{onChange:a.handleChange,value:a.values.priority,name:"priority",type:"number",className:"form-control form-control-solid",placeholder:"Độ ưu tiên"})]})}),e.jsxs("div",{className:"flex-row-sp input-wrap",children:[e.jsxs("div",{className:"wrap-item",children:[i==="ADD"?e.jsxs("label",{className:"required form-label",children:["Mã giảm giá (org subdomain + ",r,")"]}):e.jsx("label",{className:"required form-label",children:"Mã giảm giá"}),e.jsx("input",{onChange:a.handleChange,value:a.values.coupon_code,name:"coupon_code",type:"text",className:"form-control form-control-solid",placeholder:`Example:ORG${r}`}),a.errors.coupon_code&&a.touched.coupon_code&&e.jsx("span",{className:"text-danger",children:a.errors.coupon_code})]}),e.jsxs("div",{className:"wrap-item",children:[e.jsx("label",{className:"required form-label",children:"Tên"}),e.jsx("input",{onChange:a.handleChange,value:a.values.title,name:"title",type:"text",className:"form-control form-control-solid",placeholder:"Chương trình khuyến mại"}),a.errors.title&&a.touched.title&&e.jsx("span",{className:"text-danger",children:a.errors.title})]})]}),e.jsxs("div",{className:"input-wrap",children:[e.jsx("label",{className:"required form-label",children:"Mô tả"}),e.jsx("input",{onChange:a.handleChange,value:a.values.description,name:"description",type:"text",className:"form-control form-control-solid",placeholder:"Mô tả chương trình khuyến mại"}),a.errors.description&&a.touched.description&&e.jsx("span",{className:"text-danger",children:a.errors.description})]}),e.jsxs("div",{className:"flex-col input-wrap",children:[e.jsx("label",{className:"required form-label",children:"Áp dụng cho nền tảng"}),e.jsx(y,{labelId:"demo-multiple-chip-label",id:"demo-multiple-chip",multiple:!0,value:a.values.platform,onChange:a.handleChange,name:"platform",renderValue:s=>e.jsx(R,{sx:{display:"flex",flexWrap:"wrap",gap:.5},children:s==null?void 0:s.map(o=>e.jsx(oe,{platForm:o},o))}),children:ne.map(s=>e.jsx(j,{value:s,children:s},s))}),a.errors.platform&&a.touched.platform&&e.jsx("span",{className:"text-danger",children:a.errors.platform})]}),e.jsxs("div",{className:"flex-col input-wrap",children:[e.jsx(ve,{label:"Doanh nghiệp được áp dụng",origins:a.values.organizations,onChangeOrigin:s=>{x([]),a.setFieldValue("organizations",s)}}),a.errors.organizations&&a.touched.organizations&&e.jsx("span",{className:"text-danger",children:a.errors.organizations})]}),e.jsx("div",{className:"flex-col input-wrap",children:e.jsx(pe,{values:n,setValues:x,orgsChoose:a.values.organizations})}),e.jsxs("div",{className:"flex-row-sp input-wrap",children:[e.jsxs("div",{className:"flex-col wrap-item wrap-item-col-4",children:[e.jsx("label",{className:"required form-label",children:"Hình thức giảm giá "}),e.jsx(y,{labelId:"demo-simple-select-label",id:"demo-simple-select",value:a.values.discount_type,onChange:a.handleChange,name:"discount_type",children:W.map(s=>e.jsx(j,{value:s.TYPE,children:s.title},s.id))}),a.errors.discount_type&&a.touched.discount_type&&e.jsx("span",{className:"text-danger",children:a.errors.discount_type})]}),e.jsxs("div",{className:"flex-col wrap-item wrap-item-col-4",children:[e.jsx("label",{className:"required form-label",children:"Giảm giá theo"}),e.jsx(y,{labelId:"demo-simple-select-label",id:"demo-simple-select",value:a.values.discount_unit,onChange:s=>{a.setFieldValue("discount_value",""),a.setFieldValue("discount_unit",s.target.value)},name:"discount_unit",children:X.map(s=>e.jsx(j,{value:s.TYPE,children:s.title},s.id))}),a.errors.discount_unit&&a.touched.discount_unit&&e.jsx("span",{className:"text-danger",children:a.errors.discount_unit})]}),e.jsxs("div",{className:"wrap-item wrap-item-col-4",children:[e.jsxs("label",{className:"required form-label",children:[a.values.discount_type===p.FINAL_PRICE?"Giảm giá còn":"Giá trị giảm giá",a.values.discount_unit===_.PERCENT&&"(%)",a.values.discount_unit===_.PRICE&&"(VNĐ)"]}),e.jsx("input",{onChange:Y,value:a.values.discount_value,name:"discount_value",type:"text",className:"form-control form-control-solid",placeholder:a.values.discount_unit===_.PRICE?`Giá trị giảm tối đa ${J(a.values.discount_type===p.SUB_TOTAL?I:C)}đ`:"Giảm giá"}),a.errors.discount_value&&a.touched.discount_value&&e.jsx("span",{className:"text-danger",children:a.errors.discount_value})]})]}),e.jsx("div",{className:"flex-row-sp input-wrap",children:e.jsxs("div",{className:"wrap-item wrap-item-col-4",children:[e.jsx("label",{className:"form-label",children:"Giá trị đơn hàng tối thiểu"}),e.jsx("input",{onChange:q,value:a.values.minimum_order_value,name:"minimum_order_value",disabled:a.values.discount_type===p.PRODUCTS,type:"text",className:"form-control form-control-solid",placeholder:"Giá áp dụng"})]})}),e.jsxs("div",{className:"flex-row-sp input-wrap",children:[e.jsxs("div",{className:"wrap-item wrap-item-col-4",children:[e.jsx("label",{className:`${h?"required":""} form-label`,children:"Số lượng"}),e.jsx("input",{value:a.values.total,onChange:A,name:"total",type:"text",className:"form-control form-control-solid",placeholder:""}),a.errors.total&&a.touched.total&&e.jsx("span",{className:"text-danger",children:a.errors.total})]}),e.jsxs("div",{className:"wrap-item wrap-item-col-4",children:[e.jsx("label",{className:"form-label",children:"Lượt sử dụng mỗi khách hàng "}),e.jsx("input",{value:a.values.limit,onChange:k,name:"limit",type:"number",className:"form-control form-control-solid",placeholder:""})]}),e.jsx("div",{className:"wrap-item wrap-item-col-4",children:e.jsx(Z,{minDate:new Date,startDate:new Date(a.values.valid_from),endDate:new Date(a.values.valid_util),onChange:s=>{a.setFieldValue("valid_from",f(s.selection.startDate).format("YYYY-MM-DD HH:mm:ss")),a.setFieldValue("valid_util",f(s.selection.endDate).format("YYYY-MM-DD HH:mm:ss"))}})})]}),e.jsxs("div",{className:"input-form__bot",children:[e.jsx(ge,{loading:g,type:"submit",variant:"contained",size:"large",color:"success",children:"Lưu thay đổi"}),l&&(l.platform===O.SHOPEE||l.platform===O.VINID)&&e.jsx(he,{discount:l})]})]})]})}function Ee(){const v=ee(),r=ae();let l="ADD";r&&r.id&&(l="EDIT");const{data:i,refetch:m,isLoading:u}=le({queryKey:[[se.DISCOUNT,r.id]],queryFn:()=>T.getDiscountDetail({id:r.id}),enabled:!!r.id}),c=(i==null?void 0:i.context)||v.state;return e.jsxs(te,{permissions:r!=null&&r.id?["v1.discounts.update"]:["v1.discounts.store"],showEmpty:!0,children:[e.jsx(ie,{title:r!=null&&r.id?"Chỉnh thông tin giảm giá":"Tạo mới mã giảm giá"}),e.jsx("div",{className:"post d-flex flex-column-fluid",id:"kt_post",children:e.jsxs("div",{className:"container",children:[u&&e.jsx(re,{}),(l==="ADD"||c)&&e.jsx(xe,{isForm:l,discount:c,onRestoreFormEdit:m})]})})]})}export{he as ExportCode,Ee as default};
